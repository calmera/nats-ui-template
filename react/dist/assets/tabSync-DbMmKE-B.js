const l="nats-auth",i="nats-auth-state";class h{channel=null;tabId;listeners=new Set;useFallback=!1;constructor(e){this.tabId=e,this.init()}init(){if(typeof BroadcastChannel<"u")try{this.channel=new BroadcastChannel(l),this.channel.addEventListener("message",this.handleMessage)}catch{this.useFallback=!0}else this.useFallback=!0;this.useFallback&&window.addEventListener("storage",this.handleStorageEvent)}handleMessage=e=>{const t=e.data;t.sourceTabId!==this.tabId&&this.notifyListeners(t)};handleStorageEvent=e=>{if(!(e.key!==i||!e.newValue))try{const t=JSON.parse(e.newValue);if(t.sourceTabId===this.tabId)return;this.notifyListeners(t)}catch{}};notifyListeners(e){for(const t of this.listeners)try{t(e)}catch{}}send(e,t){const a={type:e,payload:t,sourceTabId:this.tabId,timestamp:Date.now()};this.channel&&!this.useFallback?this.channel.postMessage(a):localStorage.setItem(i,JSON.stringify(a))}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}requestState(){this.send("REQUEST_STATE",{})}close(){this.channel&&(this.channel.removeEventListener("message",this.handleMessage),this.channel.close(),this.channel=null),this.useFallback&&window.removeEventListener("storage",this.handleStorageEvent),this.listeners.clear()}}let s=null;function r(n){return s||(s=new h(n)),s}export{r as getTabSyncService};
